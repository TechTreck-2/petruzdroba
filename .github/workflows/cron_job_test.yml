name: Cron Job Test

on:
  schedule:
    - cron: '0 3 * * *'  # 3AM UTC
  workflow_dispatch:

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup environment
        env:
          apiUrl: ${{ secrets.apiUrl }}
        run: |
          cd techtreck-learning
          mkdir -p src/environments
          echo 'export const environment = { production: false, apiUrl: "'$apiUrl'" };' > src/environments/environment.ts
      - run: |
          cd techtreck-learning
          npm ci
          npm install cypress --save-dev
      - run: |
          cd techtreck-learning
          npm run test:ci
      - run: |
          cd techtreck-learning
          npm run test:e2e

  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          cd techtreck-learning/backend
          pip install -r requirements.txt
      - env:
          AZURE_DOMAIN: "https://dummy-azure-app.azurewebsites.net,https://dummy-frontend.netlify.app"
          DJANGO_ALLOWED_HOSTS: "dummy-frontend.netlify.app,localhost,dummy-azure-app.azurewebsites.net"
          DJANGO_CORS_ALLOWED_ORIGINS: "https://dummy-frontend.netlify.app"
          DJANGO_DEBUG: "False"
          DJANGO_SECRET_KEY: "dummysecretkey1234567890"
        run: |
          cd techtreck-learning/backend
          python manage.py test
